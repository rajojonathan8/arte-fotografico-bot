<%- include('_head', { title }) %>

<header class="p-4 bg-[#111418] border-b border-[#2b2f34]">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
        <span class="text-lg">üí¨</span>
      </div>
      <div>
        <h1 class="text-lg md:text-xl font-semibold tracking-tight text-[#f9fafb]">
          Chat con clientes
        </h1>
        <p class="text-xs md:text-sm text-slate-400">
          Vista de mensajes de WhatsApp en tiempo real desde el panel.
        </p>
      </div>
    </div>
    <a
      href="/admin"
      class="inline-flex items-center gap-1.5 text-xs md:text-sm text-slate-300 hover:text-white"
    >
      <span class="text-base">‚Üê</span>
      Volver al panel
    </a>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 md:p-6">
  <div
    class="bg-[#111418] text-[#e5e7eb] rounded-3xl shadow-sm border border-[#2b2f34] flex flex-col h-[540px] md:h-[620px] overflow-hidden"
  >
    <div class="flex flex-1 min-h-0">
      <!-- LISTA IZQUIERDA -->
      <aside
        id="chat-aside"
        class="w-64 border-r border-[#2b2f34] bg-[#0f1216] text-[#e5e7eb] flex flex-col shrink-0"
      >
        <div class="p-3 border-b border-[#2b2f34]">
          <div class="relative">
            <span class="absolute inset-y-0 left-2 flex items-center text-slate-500 text-xs">
              üîç
            </span>
            <input
              id="search"
              type="text"
              placeholder="Buscar por nombre o n√∫mero..."
              class="w-full rounded-full border border-[#2b2f34] bg-[#05070a] pl-7 pr-3 py-1.5 text-xs md:text-sm text-[#e5e7eb] placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-500"
            />
          </div>
        </div>

        <ul
          id="chat-list"
          class="flex-1 overflow-y-auto text-sm divide-y divide-[#1f242b]"
        ></ul>
      </aside>

      <!-- PANEL DERECHO -->
      <section
        id="chat-section"
        class="flex-1 flex flex-col bg-gradient-to-b from-[#1a1f25] to-[#05070a]"
      >
        <!-- Header del chat -->
        <div
          id="chat-header"
          class="px-4 py-3 border-b border-[#2b2f34] bg-[#111418] flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <!-- bot√≥n atr√°s solo en m√≥vil -->
            <button
              type="button"
              class="md:hidden mr-1 rounded-full w-8 h-8 flex items-center justify-center border border-[#2b2f34] text-slate-200 hover:bg-[#1f242b]"
              onclick="showListMobile()"
            >
              ‚Üê
            </button>

            <div class="flex flex-col">
  <p id="chat-name" class="font-semibold text-sm md:text-base text-[#f9fafb]">
    Selecciona un cliente
  </p>
  <div class="flex items-center gap-2">
    <p
      id="chat-phone"
      class="text-[11px] md:text-xs text-slate-400"
    ></p>
    <button
      id="edit-name-btn"
      type="button"
      class="hidden text-[10px] md:text-xs text-emerald-400 hover:text-emerald-300 hover:underline"
    >
      Guardar nombre
    </button>
  </div>
</div>

          </div>
         <div class="flex items-center gap-2">
  <span
    id="chat-last"
    class="text-[11px] md:text-xs text-slate-500"
  ></span>
  <button
    id="delete-chat-btn"
    type="button"
    class="hidden ml-2 inline-flex items-center justify-center rounded-full border border-red-500/40 bg-transparent px-2 py-1 text-[10px] md:text-xs text-red-400 hover:bg-red-500/10 hover:border-red-500/70 transition"
    title="Eliminar historial de este chat"
  >
    üóë
  </button>
</div>

        </div>

        <!-- Mensajes -->
        <div
          id="chat-messages"
          class="flex-1 overflow-y-auto px-3 md:px-4 py-4 space-y-2 text-xs md:text-sm bg-[radial-gradient(circle_at_top,_rgba(16,185,129,0.10)_0,_transparent_55%)]"
        >
          <div class="h-full flex items-center justify-center">
            <div class="text-center max-w-xs text-slate-400">
              <div
                class="w-10 h-10 mx-auto mb-3 rounded-2xl bg-emerald-500/15 flex items-center justify-center"
              >
                üí¨
              </div>
              <p class="text-sm font-medium text-slate-200">
                Elige un chat en la izquierda
              </p>
              <p class="text-xs mt-1 text-slate-400">
                Aqu√≠ ver√°s el historial del cliente y podr√°s responder desde el panel.
              </p>
            </div>
          </div>
        </div>

        <!-- Input de respuesta -->
        <form
          id="chat-form"
          class="border-t border-[#2b2f34] bg-[#111418] px-3 py-2 flex items-center gap-2"
        >
          <div
            class="flex-1 flex items-center gap-2 rounded-full border border-[#2b2f34] bg-[#05070a] px-3 py-1.5 focus-within:ring-2 focus-within:ring-emerald-500/70 focus-within:border-emerald-500"
          >
            <input
              id="message-input"
              type="text"
              placeholder="Escribe una respuesta para el cliente‚Ä¶"
              class="flex-1 bg-transparent text-xs md:text-sm text-[#e5e7eb] placeholder:text-slate-500 outline-none"
              autocomplete="off"
            />
          </div>
          <button
            type="submit"
            class="inline-flex items-center gap-1 rounded-full bg-emerald-600 hover:bg-emerald-700 px-3 md:px-4 py-2 text-[11px] md:text-xs font-semibold text-white shadow-sm active:scale-[0.98] transition"
          >
            <span>Enviar</span>
            <span>üì§</span>
          </button>
        </form>
      </section>
    </div>
  </div>
</main>

<script>
  // üíæ Conversaciones que viene del servidor al cargar
  let conversations = <%- JSON.stringify(conversations || []) %>;

  // A√±ade campos √∫tiles (id y texto de √∫ltima actualizaci√≥n)
  function enhanceConversations(list) {
    (list || []).forEach((c) => {
      c.id = c.phone;
      if (c.lastUpdate) {
        c.lastMessageAt = new Date(c.lastUpdate).toLocaleString("es-SV");
      } else {
        c.lastMessageAt = "";
      }
    });
  }

  enhanceConversations(conversations);

  let activeId = null;

  const chatListEl = document.getElementById("chat-list");
  const chatMessagesEl = document.getElementById("chat-messages");
  const chatNameEl = document.getElementById("chat-name");
  const chatPhoneEl = document.getElementById("chat-phone");
  const chatLastEl = document.getElementById("chat-last");
  const searchEl = document.getElementById("search");
  const formEl = document.getElementById("chat-form");
  const inputEl = document.getElementById("message-input");
  const editNameBtn = document.getElementById("edit-name-btn");
  const asideEl = document.getElementById("chat-aside");
  const sectionEl = document.getElementById("chat-section");
  const deleteChatBtn = document.getElementById("delete-chat-btn");
  let shouldAutoScroll = true;

const notifySound = new Audio("/admin-public/notify.mp3");
let lastUpdateMap = {};
let hasInitializedChatPoll = false;

// Desbloquear audio despu√©s de la primera interacci√≥n del usuario
let audioUnlocked = false;

document.addEventListener(
  "click",
  () => {
    if (audioUnlocked) return;

    notifySound.volume = 0.7;
    notifySound
      .play()
      .then(() => {
        // Lo pausamos enseguida, solo era para desbloquear
        notifySound.pause();
        notifySound.currentTime = 0;
        audioUnlocked = true;
        console.log("üîä Audio de notificaci√≥n desbloqueado");
      })
      .catch((err) => {
        console.warn("No se pudo desbloquear el audio en el primer click:", err);
      });
  },
  { once: true }
);

  // ====================== M√ìVIL: mostrar / ocultar panel derecho ======================
  function isMobile() {
    return window.innerWidth < 768; // md breakpoint
  }

  function showChatMobile() {
    if (!isMobile()) return;
    if (asideEl) asideEl.classList.add("hidden");
    if (sectionEl) sectionEl.classList.remove("hidden");
  }

  function showListMobile() {
    if (!isMobile()) return;
    activeId = null;
    if (sectionEl) sectionEl.classList.add("hidden");
    if (asideEl) asideEl.classList.remove("hidden");
    chatMessagesEl.innerHTML = `
      <div class="h-full flex items-center justify-center">
        <div class="text-center max-w-xs text-slate-400">
          <div class="w-10 h-10 mx-auto mb-3 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
            üí¨
          </div>
          <p class="text-sm font-medium text-slate-200">Elige un chat en la izquierda</p>
          <p class="text-xs mt-1 text-slate-400">Aqu√≠ ver√°s el historial del cliente y podr√°s responder desde el panel.</p>
        </div>
      </div>`;
    renderChatHeader();
  }

  window.addEventListener("resize", () => {
    if (!isMobile()) {
      // Escritorio: siempre mostrar ambos paneles
      asideEl.classList.remove("hidden");
      sectionEl.classList.remove("hidden");
    } else {
      // M√≥vil: si no hay chat activo, solo lista
      if (activeId) {
        asideEl.classList.add("hidden");
        sectionEl.classList.remove("hidden");
      } else {
        sectionEl.classList.add("hidden");
        asideEl.classList.remove("hidden");
      }
    }
  });

  // ====================== LISTA IZQUIERDA ======================
  function renderChatList(filter = "") {
    chatListEl.innerHTML = "";
    const q = filter.toLowerCase().trim();

    (conversations || []).forEach((c) => {
      const nombre = (c.name || "").toLowerCase();
if (q && !nombre.includes(q) && !(c.phone || "").includes(q)) return;

      const lastMsg =
        c.messages && c.messages.length
          ? c.messages[c.messages.length - 1].text ||
            c.messages[c.messages.length - 1].body ||
            ""
          : "";

      const li = document.createElement("li");
      const hasRealName =
  c.name &&
  c.name !== c.phone &&
  !/^arte fotografico/i.test(c.name) &&
  !/^arte fotogr√°fico/i.test(c.name);

const displayName = hasRealName ? c.name : c.phone;

      li.className =
        "cursor-pointer transition-all hover:bg-[#1f242b] " +
        (c.id === activeId ? "bg-[#1f242b]" : "");

      li.innerHTML = `
        <button class="w-full text-left px-3 py-2.5 flex items-center gap-3">
          <div class="w-9 h-9 rounded-full bg-emerald-500/15 flex items-center justify-center text-emerald-400 font-semibold text-sm">
            ${displayName.charAt(0).toUpperCase()}
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-center gap-2">
              <span class="text-[13px] font-semibold text-slate-100">
                ${displayName}
              </span>
              <span class="text-[10px] text-slate-500 whitespace-nowrap">
                ${c.lastMessageAt || ""}
              </span>
            </div>

            <span class="text-[11px] text-slate-400 truncate block mt-0.5">
              ${lastMsg}
            </span>
          </div>
        </button>
      `;

      li.addEventListener("click", () => {
        activeId = c.id;
        renderChatHeader();
        shouldAutoScroll = true;
        renderMessages();
        renderChatList(q);
        showChatMobile(); // para m√≥vil
      });

      chatListEl.appendChild(li);
    });

    if (!chatListEl.children.length) {
      const li = document.createElement("li");
      li.className = "p-3 text-[11px] text-slate-500";
      li.textContent = "No se encontraron clientes.";
      chatListEl.appendChild(li);
    }
  }

  function getActiveConversation() {
    return (conversations || []).find((c) => c.id === activeId) || null;
  }

  // ====================== CABECERA DERECHA ======================
  function renderChatHeader() {
  const c = getActiveConversation();
  if (!c) {
    chatNameEl.textContent = "Selecciona un cliente";
    chatPhoneEl.textContent = "";
    chatLastEl.textContent = "";
    if (editNameBtn) editNameBtn.classList.add("hidden");
    if (deleteChatBtn) deleteChatBtn.classList.add("hidden");
    return;
  }

  const hasRealName =
    c.name &&
    c.name !== c.phone &&
    !/^arte fotografico/i.test(c.name) &&
    !/^arte fotogr√°fico/i.test(c.name);

  if (hasRealName) {
    // Ya tiene nombre guardado
    chatNameEl.textContent = c.name;
    chatPhoneEl.textContent = c.phone;
    if (editNameBtn) {
      editNameBtn.textContent = "Editar nombre";
      editNameBtn.classList.remove("hidden");
    }
  } else {
    // Solo n√∫mero (sin nombre guardado)
    chatNameEl.textContent = c.phone;
    chatPhoneEl.textContent = "Sin nombre guardado";
    if (editNameBtn) {
      editNameBtn.textContent = "Guardar nombre";
      editNameBtn.classList.remove("hidden");
    }
  }

  chatLastEl.textContent = c.lastMessageAt || "";

  // Bot√≥n de eliminar siempre visible cuando hay chat activo
  if (deleteChatBtn) deleteChatBtn.classList.remove("hidden");
}



  // ====================== MENSAJES DERECHA ======================
  function renderMessages() {
    const c = getActiveConversation();
    chatMessagesEl.innerHTML = "";

    if (!c) {
      chatMessagesEl.innerHTML = `
        <div class="h-full flex items-center justify-center">
          <div class="text-center max-w-xs text-slate-400">
            <div class="w-10 h-10 mx-auto mb-3 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
              üí¨
            </div>
            <p class="text-sm font-medium text-slate-200">Elige un chat en la izquierda</p>
            <p class="text-xs mt-1 text-slate-400">Aqu√≠ ver√°s el historial del cliente y podr√°s responder desde el panel.</p>
          </div>
        </div>`;
      return;
    }

    let lastFrom = null;

    (c.messages || []).forEach((m) => {
      const isClient = m.from === "cliente";

      const contenido =
        m.text !== undefined && m.text !== null && m.text !== ""
          ? m.text
          : m.body !== undefined && m.body !== null
          ? m.body
          : "";

      const isFirstOfGroup = m.from !== lastFrom;
      lastFrom = m.from;

      const wrap = document.createElement("div");
      wrap.className =
        "w-full flex" +
        (isClient ? " justify-start" : " justify-end") +
        (isFirstOfGroup ? " mt-3" : " mt-1");

      const bubble = document.createElement("div");
      bubble.className =
        "relative max-w-[72%] rounded-3xl px-4 py-2 text-xs md:text-sm shadow-sm " +
        (isClient
          ? "bg-[#2d333b] text-[#e5e7eb] border border-[#3a3f45]"
          : "bg-[#059669] text-white");

      const hora = m.timestamp
        ? new Date(m.timestamp).toLocaleTimeString("es-SV", {
            hour: "2-digit",
            minute: "2-digit",
          })
        : "";

      bubble.innerHTML = `
        <div class="whitespace-pre-wrap break-words leading-relaxed">${contenido}</div>
        <div class="text-[10px] mt-1 opacity-70 text-right">${hora}</div>
      `;

      wrap.appendChild(bubble);
      chatMessagesEl.appendChild(wrap);
    });

    if (shouldAutoScroll) {
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
  }

// ====================== GUARDAR NOMBRE DEL CLIENTE ======================
if (editNameBtn) {
  editNameBtn.addEventListener("click", async () => {
    const c = getActiveConversation();
    if (!c) return;

    const current =
      c.name && c.name !== c.phone ? c.name : "";

    const nuevo = prompt("Escribe el nombre del cliente:", current);
    if (!nuevo) return;

    const name = nuevo.trim();
    if (!name) return;

    // Actualizamos en memoria
    c.name = name;
    renderChatHeader();
    renderChatList(searchEl.value || "");

    // Guardamos en el backend
    try {
      const resp = await fetch("/admin/api/chat/name", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: c.phone, name }),
      });
      if (!resp.ok) {
        console.error("Error al guardar nombre del cliente");
      }
    } catch (err) {
      console.error("Error de red al guardar nombre del cliente:", err);
    }
  });
}

// ====================== ELIMINAR CHAT DESDE EL PANEL ======================
if (deleteChatBtn) {
  deleteChatBtn.addEventListener("click", async () => {
    const c = getActiveConversation();
    if (!c) return;

    const label = c.name && c.name !== c.phone ? `${c.name} (${c.phone})` : c.phone;

    const confirmar = confirm(
      `¬øSeguro que deseas eliminar el historial de chat con:\n\n${label}?\n\n` +
      'Esto NO borra los mensajes de WhatsApp, solo el historial del panel.'
    );
    if (!confirmar) return;

    try {
      const resp = await fetch("/admin/api/chat/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: c.phone }),
      });

      if (!resp.ok) {
        console.error("Error al eliminar chat en el servidor");
        alert("No se pudo eliminar el chat. Intenta de nuevo.");
        return;
      }

      const data = await resp.json();
      if (!data.ok) {
        console.error("Respuesta de error al eliminar chat:", data);
        alert("No se pudo eliminar el chat. Intenta de nuevo.");
        return;
      }

      // üßπ Actualizar lista en memoria
      conversations = (conversations || []).filter((conv) => conv.phone !== c.phone);

      // Ajustar el activo
      if (conversations.length > 0) {
        activeId = conversations[0].id;
      } else {
        activeId = null;
      }

      renderChatHeader();
      renderChatList(searchEl.value || "");
      renderMessages();

      if (!activeId) {
        // mostrar pantalla vac√≠a si ya no hay chats
        chatMessagesEl.innerHTML = `
          <div class="h-full flex items-center justify-center">
            <div class="text-center max-w-xs text-slate-400">
              <div class="w-10 h-10 mx-auto mb-3 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
                üí¨
              </div>
              <p class="text-sm font-medium text-slate-200">No hay chats registrados</p>
              <p class="text-xs mt-1 text-slate-400">
                Cuando lleguen mensajes nuevos, aparecer√°n autom√°ticamente aqu√≠.
              </p>
            </div>
          </div>`;
      }
    } catch (err) {
      console.error("Error de red al eliminar chat:", err);
      alert("Error de red al eliminar el chat. Revisa la consola.");
    }
  });
}

  // ====================== CARGAR DESDE EL SERVIDOR ======================
// ====================== CARGAR DESDE EL SERVIDOR (con notificaci√≥n) ======================
async function reloadFromServer() {
  try {
    // Mantener auto-scroll si el usuario est√° casi abajo
    if (chatMessagesEl) {
      const distance =
        chatMessagesEl.scrollHeight -
        (chatMessagesEl.scrollTop + chatMessagesEl.clientHeight);
      shouldAutoScroll = distance < 120;
    }

    // üìù Guardamos el estado anterior para comparar
    const prevMap = { ...lastUpdateMap };

    const res = await fetch("/admin/api/chat");
    const data = await res.json();

    conversations = Array.isArray(data) ? data : [];
    enhanceConversations(conversations);

    // üîÑ Reconstruimos el mapa con la info nueva
    lastUpdateMap = {};
    (conversations || []).forEach((c) => {
      lastUpdateMap[c.phone] = c.lastUpdate || 0;
    });

    // üîî Detectar NUEVOS mensajes de CLIENTE (no en la primera carga)
    if (hasInitializedChatPoll) {
      let shouldNotify = false;

      (conversations || []).forEach((c) => {
        const prev = prevMap[c.phone] || 0;
        const current = c.lastUpdate || 0;

        if (current > prev) {
          const msgs = c.messages || [];
          if (msgs.length) {
            const last = msgs[msgs.length - 1];
            if (last.from === "cliente") {
              shouldNotify = true;
            }
          }
        }
      });

      if (shouldNotify) {
        // Sonido
        try {
          notifySound.currentTime = 0;
          notifySound.play().catch(() => {});
        } catch (e) {
          console.warn("No se pudo reproducir el sonido:", e);
        }

        // ‚ú® Animaci√≥n suave en el header
        const header = document.getElementById("chat-header");
        if (header) {
          header.classList.add("animate-pulse");
          setTimeout(() => header.classList.remove("animate-pulse"), 600);
        }
      }
    } else {
      // La primera vez solo inicializamos, sin sonar
      hasInitializedChatPoll = true;
    }

    // Mantener selecci√≥n de chat
    if (!activeId && conversations.length > 0) {
      activeId = conversations[0].id;
    }

    renderChatHeader();
    renderChatList(searchEl.value || "");
    renderMessages();
  } catch (err) {
    console.error("Error recargando conversaciones:", err);
  }
}


  // ====================== B√öSQUEDA ======================
  searchEl.addEventListener("input", (e) => {
    renderChatList(e.target.value);
  });

  // ====================== ENV√çO DESDE EL PANEL ======================
  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = inputEl.value.trim();
    if (!text || !activeId) return;

    const c = getActiveConversation();
    if (!c) return;

    const phone = c.phone;

    const ts = Date.now();
    c.messages = c.messages || [];
    c.messages.push({
      from: "bot",
      text,
      timestamp: ts,
    });
    c.lastMessageAt = new Date(ts).toLocaleString("es-SV");
    inputEl.value = "";
    shouldAutoScroll = true;

    renderMessages();
    renderChatList(searchEl.value || "");

    try {
      const resp = await fetch("/admin/api/chat/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to: phone, text }),
      });

      if (!resp.ok) {
        console.error("Error al enviar mensaje desde el panel");
      }
    } catch (err) {
      console.error("Error de red al enviar mensaje:", err);
    }
  });

  // ====================== INICIO ======================
  window.addEventListener("DOMContentLoaded", () => {
    // estado inicial responsive
    if (isMobile()) {
      // en m√≥vil arrancamos solo con la lista
      sectionEl.classList.add("hidden");
      asideEl.classList.remove("hidden");
    } else {
      asideEl.classList.remove("hidden");
      sectionEl.classList.remove("hidden");
    }

    reloadFromServer(); // carga inicial
    setInterval(reloadFromServer, 5000); // refresca cada 5 segundos
  });
</script>

<%- include('_foot') %>
