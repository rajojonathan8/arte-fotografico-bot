<%- include('_head', { title }) %>

<header class="p-4 bg-white shadow">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold">Chat con clientes</h1>
      <p class="text-sm text-slate-500">
        Vista de mensajes de WhatsApp en tiempo real.
      </p>
    </div>
    <a href="/admin" class="text-sm text-slate-600 hover:text-slate-900">‚Üê Volver al panel</a>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4">
  <div class="bg-white rounded-2xl shadow border border-slate-200 flex flex-col h-[540px] md:h-[600px] overflow-hidden">

    <div class="flex flex-1 min-h-0">
      <!-- LISTA IZQUIERDA -->
      <aside id="chat-aside" class="w-64 border-r border-slate-200 bg-slate-50 flex flex-col">
        <div class="p-3 border-b border-slate-200">
          <input
            id="search"
            type="text"
            placeholder="Buscar cliente..."
            class="w-full rounded-full border border-slate-300 bg-white px-3 py-1.5 text-sm"
          />
        </div>

        <ul id="chat-list" class="flex-1 overflow-y-auto text-sm"></ul>
      </aside>

      <!-- PANEL DERECHO -->
      <section
        id="chat-section"
        class="flex-1 flex flex-col bg-gradient-to-b from-slate-50 to-slate-100"
      >

        <div id="chat-header" class="px-4 py-3 border-b border-slate-200 bg-white flex items-center justify-between">
          <div class="flex items-center gap-2">
            <!-- bot√≥n atr√°s solo en m√≥vil -->
            <button
              type="button"
              class="md:hidden mr-1 rounded-full w-8 h-8 flex items-center justify-center border border-slate-200 text-slate-600 hover:bg-slate-100"
              onclick="showListMobile()"
            >
              ‚Üê
            </button>

            <div>
              <p id="chat-name" class="font-semibold text-slate-900">Selecciona un cliente</p>
              <p id="chat-phone" class="text-xs text-slate-500"></p>
            </div>
          </div>
          <span id="chat-last" class="text-xs text-slate-400"></span>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm">
          <p class="text-slate-400 text-center mt-10">Elige un chat en la izquierda.</p>
        </div>

        <form id="chat-form" class="border-t border-slate-200 bg-white px-3 py-2 flex items-center gap-2">
          <input
            id="message-input"
            type="text"
            placeholder="Responder al cliente‚Ä¶"
            class="flex-1 rounded-full border border-slate-300 px-3 py-2 text-sm"
            autocomplete="off"
          />
          <button
            type="submit"
            class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-white"
          >
            Enviar
          </button>
        </form>

      </section>
    </div>
  </div>
</main>

<script>
  // üíæ Conversaciones que viene del servidor al cargar
  let conversations = <%- JSON.stringify(conversations || []) %>;

  // A√±ade campos √∫tiles (id y texto de √∫ltima actualizaci√≥n)
  function enhanceConversations(list) {
    (list || []).forEach(c => {
      c.id = c.phone;
      if (c.lastUpdate) {
        c.lastMessageAt = new Date(c.lastUpdate).toLocaleString("es-SV");
      } else {
        c.lastMessageAt = "";
      }
    });
  }

  enhanceConversations(conversations);

  let activeId = null;

  const chatListEl     = document.getElementById('chat-list');
  const chatMessagesEl = document.getElementById('chat-messages');
  const chatNameEl     = document.getElementById('chat-name');
  const chatPhoneEl    = document.getElementById('chat-phone');
  const chatLastEl     = document.getElementById('chat-last');
  const searchEl       = document.getElementById('search');
  const formEl         = document.getElementById('chat-form');
  const inputEl        = document.getElementById('message-input');

  const asideEl        = document.getElementById('chat-aside');
  const sectionEl      = document.getElementById('chat-section');

  let shouldAutoScroll = true;

  // ====================== M√ìVIL: mostrar / ocultar panel derecho ======================
  function isMobile() {
    return window.innerWidth < 768; // md breakpoint
  }

  function showChatMobile() {
    if (!isMobile()) return;
    if (asideEl)   asideEl.classList.add('hidden');
    if (sectionEl) sectionEl.classList.remove('hidden');
  }

  function showListMobile() {
    if (!isMobile()) return;
    activeId = null;
    if (sectionEl) sectionEl.classList.add('hidden');
    if (asideEl)   asideEl.classList.remove('hidden');
    chatMessagesEl.innerHTML =
      `<p class="text-slate-400 text-center mt-10">Elige un chat en la izquierda.</p>`;
    renderChatHeader();
  }

  window.addEventListener("resize", () => {
    if (!isMobile()) {
      // Escritorio: siempre mostrar ambos paneles
      asideEl.classList.remove('hidden');
      sectionEl.classList.remove('hidden');
    } else {
      // M√≥vil: si no hay chat activo, solo lista
      if (activeId) {
        asideEl.classList.add('hidden');
        sectionEl.classList.remove('hidden');
      } else {
        sectionEl.classList.add('hidden');
        asideEl.classList.remove('hidden');
      }
    }
  });

  // ====================== LISTA IZQUIERDA ======================
  function renderChatList(filter = "") {
    chatListEl.innerHTML = "";
    const q = filter.toLowerCase().trim();

    (conversations || []).forEach(c => {
      if (q && !c.name.toLowerCase().includes(q) && !c.phone.includes(q)) return;

      const li = document.createElement("li");
      li.className =
        "border-b border-slate-200 cursor-pointer transition-all hover:bg-emerald-50 " +
        (c.id === activeId ? "bg-emerald-100" : "bg-slate-50");

      li.innerHTML = `
        <button class="w-full text-left px-3 py-3 flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold">
            ${c.name.charAt(0).toUpperCase()}
          </div>

          <div class="flex-1">
            <div class="flex justify-between items-center">
              <span class="text-sm font-semibold text-slate-900">
                ${c.name}
              </span>
              <span class="text-[11px] text-slate-400 ml-2 whitespace-nowrap">
                ${c.lastMessageAt || ""}
              </span>
            </div>

            <span class="text-xs text-slate-500 truncate block">
              ${
                (c.messages && c.messages.length)
                  ? (c.messages[c.messages.length - 1].text || c.messages[c.messages.length - 1].body || "")
                  : ""
              }
            </span>
          </div>
        </button>
      `;

      li.addEventListener("click", () => {
        activeId = c.id;
        renderChatHeader();
        shouldAutoScroll = true;
        renderMessages();
        renderChatList(q);
        showChatMobile(); // para m√≥vil
      });

      chatListEl.appendChild(li);
    });

    if (!chatListEl.children.length) {
      const li = document.createElement("li");
      li.className = "p-3 text-xs text-slate-400";
      li.textContent = "No se encontraron clientes.";
      chatListEl.appendChild(li);
    }
  }

  function getActiveConversation() {
    return (conversations || []).find(c => c.id === activeId) || null;
  }

  // ====================== CABECERA DERECHA ======================
  function renderChatHeader() {
    const c = getActiveConversation();
    if (!c) {
      chatNameEl.textContent = "Selecciona un cliente";
      chatPhoneEl.textContent = "";
      chatLastEl.textContent = "";
      return;
    }
    chatNameEl.textContent = c.name;
    chatPhoneEl.textContent = c.phone;
    chatLastEl.textContent = c.lastMessageAt || "";
  }

  // ====================== MENSAJES DERECHA ======================
  function renderMessages() {
    const c = getActiveConversation();
    chatMessagesEl.innerHTML = "";

    if (!c) {
      chatMessagesEl.innerHTML = `<p class="text-slate-400 text-center mt-10">Elige un chat en la izquierda.</p>`;
      return;
    }

    let lastFrom = null;

    (c.messages || []).forEach(m => {
      const isClient = m.from === "cliente";

      const contenido =
        (m.text !== undefined && m.text !== null && m.text !== "")
          ? m.text
          : (m.body !== undefined && m.body !== null
              ? m.body
              : "");

      const isFirstOfGroup = m.from !== lastFrom;
      lastFrom = m.from;

      const wrap = document.createElement("div");
      wrap.className =
        "w-full flex" +
        (isClient ? " justify-start" : " justify-end") +
        (isFirstOfGroup ? " mt-3" : " mt-1");

      const bubble = document.createElement("div");
      bubble.className =
        "relative max-w-[70%] rounded-3xl px-4 py-2 text-sm shadow-sm " +
        (isClient
          ? "bg-white text-slate-900 border border-slate-200"
          : "bg-emerald-500 text-white");

      const hora = m.timestamp
        ? new Date(m.timestamp).toLocaleTimeString("es-SV", {
            hour: "2-digit",
            minute: "2-digit",
          })
        : "";

      bubble.innerHTML = `
        <div class="whitespace-pre-wrap break-words">${contenido}</div>
        <div class="text-[10px] mt-1 opacity-70 text-right">${hora}</div>
      `;

      wrap.appendChild(bubble);
      chatMessagesEl.appendChild(wrap);
    });

    if (shouldAutoScroll) {
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
  }

  // ====================== CARGAR DESDE EL SERVIDOR ======================
  async function reloadFromServer() {
    try {
      if (chatMessagesEl) {
        const distance =
          chatMessagesEl.scrollHeight -
          (chatMessagesEl.scrollTop + chatMessagesEl.clientHeight);
        shouldAutoScroll = distance < 120;
      }

      const res = await fetch('/admin/api/chat');
      const data = await res.json();

      conversations = Array.isArray(data) ? data : [];
      enhanceConversations(conversations);

      if (!activeId && conversations.length > 0) {
        activeId = conversations[0].id;
      }

      renderChatHeader();
      renderChatList(searchEl.value || "");
      renderMessages();
    } catch (err) {
      console.error('Error recargando conversaciones:', err);
    }
  }

  // ====================== B√öSQUEDA ======================
  searchEl.addEventListener("input", e => {
    renderChatList(e.target.value);
  });

  // ====================== ENV√çO DESDE EL PANEL ======================
  formEl.addEventListener("submit", async e => {
    e.preventDefault();
    const text = inputEl.value.trim();
    if (!text || !activeId) return;

    const c = getActiveConversation();
    if (!c) return;

    const phone = c.phone;

    const ts = Date.now();
    c.messages = c.messages || [];
    c.messages.push({
      from: "bot",
      text,
      timestamp: ts,
    });
    c.lastMessageAt = new Date(ts).toLocaleString("es-SV");
    inputEl.value = "";
    shouldAutoScroll = true;

    renderMessages();
    renderChatList(searchEl.value || "");

    try {
      const resp = await fetch('/admin/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: phone, text }),
      });

      if (!resp.ok) {
        console.error('Error al enviar mensaje desde el panel');
      }
    } catch (err) {
      console.error('Error de red al enviar mensaje:', err);
    }
  });

  // ====================== INICIO ======================
  window.addEventListener("DOMContentLoaded", () => {
    // estado inicial responsive
    if (isMobile()) {
      // en m√≥vil arrancamos solo con la lista
      sectionEl.classList.add('hidden');
      asideEl.classList.remove('hidden');
    } else {
      asideEl.classList.remove('hidden');
      sectionEl.classList.remove('hidden');
    }

    reloadFromServer();               // carga inicial
    setInterval(reloadFromServer, 5000); // refresca cada 5 segundos
  });
</script>

<%- include('_foot') %>
