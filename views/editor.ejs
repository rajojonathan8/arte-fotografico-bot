<%- include('_head', { title }) %> 

<%
  function fechaCorta(v) {
    if (!v) return '';
    const d = new Date(v);
    if (isNaN(d)) return '';
    return d.toISOString().slice(0, 10); // YYYY-MM-DD
  }
%>

<header class="p-4 bg-white shadow">
  <div class="max-w-6xl mx-auto flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold">Panel del editor</h1>
      <p class="text-sm text-slate-500">
        Vista r√°pida de entregas del d√≠a y √≥rdenes urgentes para impresi√≥n.
      </p>
    </div>
    <a href="/admin" class="text-sm text-slate-600 hover:text-slate-900">
      ‚Üê Volver al panel
    </a>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 space-y-6">

  <!-- ================= RESUMEN R√ÅPIDO ================= -->
  <section class="grid sm:grid-cols-2 gap-4">
    <article class="bg-slate-900/80 text-slate-100 rounded-2xl border border-slate-700 p-4">
      <p class="text-xs uppercase text-slate-400 font-semibold">Resumen</p>
      <p class="mt-2 text-sm">
        Entregas de hoy pendientes:
        <span class="font-semibold">
          <%= (entregasHoy && entregasHoy.length) || 0 %>
        </span>
      </p>
      <p class="text-sm">
        √ìrdenes urgentes pendientes:
        <span class="font-semibold">
          <%= (urgentes && urgentes.length) || 0 %>
        </span>
      </p>
    </article>

    <article class="bg-slate-900/80 text-slate-100 rounded-2xl border border-slate-700 p-4 text-sm">
      <p class="text-xs uppercase text-slate-400 font-semibold">Leyenda</p>
      <ul class="mt-2 space-y-1">
        <li>üü° <strong>Pendiente</strong>: a√∫n no se han marcado como impresos.</li>
        <li>üü¢ <strong>Impresos</strong>: ya marcados como impresos
          (columna <code>impresos = true</code>, no cambia el estado de entrega).
        </li>
      </ul>
    </article>
  </section>

  <!-- =============== ENTREGAS DE HOY =============== -->
  <section class="bg-white rounded-2xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">Entregas de hoy</h2>
      <p class="text-xs text-slate-500">
        Solo se muestran √≥rdenes con fecha de entrega de hoy y a√∫n pendientes de impresi√≥n.
      </p>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-3 py-2 text-left">Tipo</th>
            <th class="px-3 py-2 text-left">Nombre / Instituci√≥n</th>
            <th class="px-3 py-2 text-left">Detalle</th>
            <th class="px-3 py-2 text-left">Fecha toma</th>
            <th class="px-3 py-2 text-left">Fecha entrega</th>
            <th class="px-3 py-2 text-center">Urgencia</th>
            <th class="px-3 py-2 text-center">Impresos</th>
            <th class="px-3 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <% if (!entregasHoy || entregasHoy.length === 0) { %>
            <tr>
              <td colspan="8" class="px-3 py-4 text-center text-slate-500">
                No hay entregas pendientes para hoy.
              </td>
            </tr>
          <% } else { %>
            <% entregasHoy.forEach(o => {
                 const esPersona = o._tipo === 'persona';
                 const urg = o.urgencia || 'Normal';
                 const impresos = !!o.impresos;
            %>
              <tr class="hover:bg-slate-50">
                <!-- Tipo -->
                <td class="px-3 py-2">
                  <% if (esPersona) { %>
                    <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-emerald-600 text-white font-semibold">
  Persona
</span>
                  <% } else { %>
                    <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-sky-600 text-white font-semibold">
  Instituci√≥n
</span>
                  <% } %>
                </td>

                <!-- Nombre / Instituci√≥n -->
                <td class="px-3 py-2">
                  <%= esPersona ? (o.nombre || '') : (o.institucion || '') %>
                </td>

                <!-- Detalle -->
                <td class="px-3 py-2">
                  <% if (esPersona) { %>
                    Orden: <%= o.numero_orden || '' %> ¬∑ Toma: <%= o.numero_toma || '' %>
                  <% } else { %>
                    <%= o.seccion || '' %> ¬∑ Paquete: <%= o.paquete || '' %>
                  <% } %>
                </td>

                <!-- Fechas -->
                <td class="px-3 py-2"><%= fechaCorta(o.fecha_toma) %></td>
                <td class="px-3 py-2"><%= fechaCorta(o.fecha_entrega) %></td>

                <!-- Urgencia -->
                <td class="px-3 py-2 text-center">
                  <% if (urg === 'Urgente' || urg === 'Muy urgente') { %>
                    <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-red-100 text-red-700 font-semibold">
                      <%= urg %>
                    </span>
                  <% } else { %>
                    <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-slate-100 text-slate-700">
                      <%= urg %>
                    </span>
                  <% } %>
                </td>

                <!-- Impresos -->
                <td class="px-3 py-2 text-center">
                  <% if (impresos) { %>
                    <span class="inline-flex px-3 py-1 rounded-full text-[11px] bg-emerald-500 text-white font-semibold">
                      Impresos
                    </span>
                  <% } else { %>
                    <span class="inline-flex px-3 py-1 rounded-full text-[11px] bg-amber-400 text-slate-900 font-semibold">
                      Pendiente
                    </span>
                  <% } %>
                </td>

                <!-- Acciones -->
                <td class="px-3 py-2 text-center">
                  <% if (!impresos) { %>
                    <form
                      method="POST"
                      action="/admin/editor/impresos"
                      onsubmit="return confirm('¬øMarcar esta orden como IMPRESOS?');"
                      class="inline">
                      <input type="hidden" name="id" value="<%= o.id %>">
                      <input type="hidden" name="tipo" value="<%= esPersona ? 'persona' : 'institucion' %>">
                      <button
                        type="submit"
                        class="px-3 py-1.5 rounded-full text-xs bg-emerald-600 text-white hover:bg-emerald-700">
                        Marcar como impresos
                      </button>
                    </form>
                  <% } else { %>
                    <span class="text-xs text-slate-400">Ya marcado</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- =============== √ìRDENES URGENTES =============== -->
  <section class="bg-white rounded-2xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">√ìrdenes urgentes / muy urgentes</h2>
      <p class="text-xs text-slate-500">
        Todas las √≥rdenes urgentes pendientes, aunque su entrega no sea hoy.
      </p>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-3 py-2 text-left">Tipo</th>
            <th class="px-3 py-2 text-left">Nombre / Instituci√≥n</th>
            <th class="px-3 py-2 text-left">Detalle</th>
            <th class="px-3 py-2 text-left">Fecha toma</th>
            <th class="px-3 py-2 text-left">Fecha entrega</th>
            <th class="px-3 py-2 text-center">Urgencia</th>
            <th class="px-3 py-2 text-center">Impresos</th>
            <th class="px-3 py-2 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <% if (!urgentes || urgentes.length === 0) { %>
            <tr>
              <td colspan="8" class="px-3 py-4 text-center text-slate-500">
                No hay √≥rdenes urgentes pendientes.
              </td>
            </tr>
          <% } else { %>
            <% urgentes.forEach(o => {
                 const esPersona = o._tipo === 'persona';
                 const urg = o.urgencia || 'Normal';
                 const impresos = !!o.impresos;
            %>
              <tr class="hover:bg-slate-50">
                <!-- Tipo -->
                <td class="px-3 py-2">
                  <% if (esPersona) { %>
                    <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-emerald-600 text-white font-semibold">
  Persona
</span>
                  <% } else { %>
                    <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-sky-600 text-white font-semibold">
  Instituci√≥n
</span>
                  <% } %>
                </td>

                <!-- Nombre / Instituci√≥n -->
                <td class="px-3 py-2">
                  <%= esPersona ? (o.nombre || '') : (o.institucion || '') %>
                </td>

                <!-- Detalle -->
                <td class="px-3 py-2">
                  <% if (esPersona) { %>
                    Orden: <%= o.numero_orden || '' %> ¬∑ Toma: <%= o.numero_toma || '' %>
                  <% } else { %>
                    <%= o.seccion || '' %> ¬∑ Paquete: <%= o.paquete || '' %>
                  <% } %>
                </td>

                <!-- Fechas -->
                <td class="px-3 py-2"><%= fechaCorta(o.fecha_toma) %></td>
                <td class="px-3 py-2"><%= fechaCorta(o.fecha_entrega) %></td>

                <!-- Urgencia -->
                <td class="px-3 py-2 text-center">
                  <span class="inline-flex px-2 py-1 rounded-full text-[11px] bg-red-100 text-red-700 font-semibold">
                    <%= urg %>
                  </span>
                </td>

                <!-- Impresos -->
                <td class="px-3 py-2 text-center">
                  <% if (impresos) { %>
                    <span class="inline-flex px-3 py-1 rounded-full text-[11px] bg-emerald-500 text-white font-semibold">
                      Impresos
                    </span>
                  <% } else { %>
                    <span class="inline-flex px-3 py-1 rounded-full text-[11px] bg-amber-400 text-slate-900 font-semibold">
                      Pendiente
                    </span>
                  <% } %>
                </td>

                <!-- Acciones -->
                <td class="px-3 py-2 text-center">
                  <% if (!impresos) { %>
                    <form
                      method="POST"
                      action="/admin/editor/impresos"
                      onsubmit="return confirm('¬øMarcar esta orden como IMPRESOS?');"
                      class="inline">
                      <input type="hidden" name="id" value="<%= o.id %>">
                      <input type="hidden" name="tipo" value="<%= esPersona ? 'persona' : 'institucion' %>">
                      <button
                        type="submit"
                        class="px-3 py-1.5 rounded-full text-xs bg-emerald-600 text-white hover:bg-emerald-700">
                        Marcar como impresos
                      </button>
                    </form>
                  <% } else { %>
                    <span class="text-xs text-slate-400">Ya marcado</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>
</main>

<%- include('_foot') %>
