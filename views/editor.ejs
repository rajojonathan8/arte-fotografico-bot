<%- include('_head', { title }) %>
<%
function formatDate(d) {
  if (!d) return '-';
  const date = new Date(d);
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${day}/${m}/${y}`; // cambia a ${y}-${m}-${day} si lo prefieres
}
%>

<main class="max-w-6xl mx-auto p-4 space-y-6">

  <!-- Header -->
  <header class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-slate-100">Panel del editor</h1>
      <p class="text-sm text-slate-400 mt-1">
        AquÃ­ verÃ¡s entregas dentro del rango seleccionado (por defecto: hoy â†’ +<%= diasDespues || 8 %> dÃ­as), mÃ¡s las urgentes.
        Orden recomendado: <strong>Editar â†’ Imprimir</strong> â†’ Marcar <strong>editado</strong> â†’ Marcar <strong>impreso</strong>.
      </p>
    </div>

    <div class="flex items-center gap-3">
      <a href="/admin" class="text-sm text-slate-300 hover:text-white">â† Volver al panel</a>
      <a href="/admin/ordenes?tab=personas" class="text-sm text-slate-300 hover:text-white">Ver Ã³rdenes</a>
    </div>
  </header>

  <!-- Filtros -->
  <section class="bg-slate-900/60 border border-slate-700 rounded-2xl p-4">
    <form method="GET" action="/admin/editor" class="grid md:grid-cols-6 gap-3 items-end">
      <div class="md:col-span-2">
        <label class="block text-xs font-medium text-slate-300 mb-1">Entrega desde</label>
        <input
          type="date"
          name="entrega_desde"
          value="<%= entregaDesde || '' %>"
          class="w-full rounded-lg bg-slate-950/60 border border-slate-700 px-3 py-2 text-sm text-slate-100"
        />
      </div>

      <div class="md:col-span-2">
        <label class="block text-xs font-medium text-slate-300 mb-1">Entrega hasta</label>
        <input
          type="date"
          name="entrega_hasta"
          value="<%= entregaHasta || '' %>"
          class="w-full rounded-lg bg-slate-950/60 border border-slate-700 px-3 py-2 text-sm text-slate-100"
        />
      </div>

      <div class="md:col-span-2 flex gap-2">
        <button
          type="submit"
          class="px-4 py-2 rounded-full bg-emerald-600 text-white text-sm hover:bg-emerald-500"
        >
          Filtrar
        </button>
        <a
          href="/admin/editor"
          class="px-4 py-2 rounded-full bg-slate-200 text-slate-900 text-sm hover:bg-white"
        >
          Limpiar
        </a>
      </div>

      <div class="md:col-span-6 text-xs text-slate-400 mt-1">
        Rango actual: <span class="text-slate-200"><%= entregaDesde %></span> â†’ <span class="text-slate-200"><%= entregaHasta %></span>
      </div>
    </form>
  </section>

  <!-- Entregas en rango -->
  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-100">Entregas en rango (<%= (entregasRango || []).length %>)</h2>
      <p class="text-xs text-slate-400">Pendientes de impresiÃ³n: se muestran aunque no estÃ©n â€œEntregadoâ€.</p>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <% (entregasRango || []).forEach(o => { %>
        <div class="bg-slate-900/60 border border-slate-700 rounded-2xl p-4">
          <div class="flex items-center justify-between gap-3">
            <div class="text-sm text-slate-200">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px]
                <%= o._tipo === 'persona'
                  ? 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/20'
                  : 'bg-sky-500/15 text-sky-300 border border-sky-500/20' %>">
                <%= o._tipo === 'persona' ? 'Persona' : 'InstituciÃ³n' %>
              </span>
              <span class="ml-2 text-slate-400 text-xs">ID <%= o.id %></span>
            </div>

            <div class="flex items-center gap-2">
              <% if (o.editado) { %>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] bg-emerald-500/15 text-emerald-300 border border-emerald-500/20">
                  Editado
                </span>
              <% } %>
              <% if (o.impresos) { %>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] bg-rose-500/15 text-rose-300 border border-rose-500/20">
                  Impreso
                </span>
              <% } %>
            </div>
          </div>

          <div class="mt-3 text-sm text-slate-100 font-semibold">
            <%= o._tipo === 'persona' ? (o.nombre || '-') : (o.institucion || '-') %>
          </div>

          <div class="mt-2 text-xs text-slate-300 space-y-1">
            <div><span class="text-slate-400">Detalle:</span>
              <% if (o._tipo === 'persona') { %>
                Orden: <%= (o.numero_orden || '-') %> Â· Toma: <%= (o.numero_toma || '-') %>
              <% } else { %>
                <%= (o.paquete || '-') %> Â· <%= (o.seccion || '-') %>
              <% } %>
            </div>

            <div>
  <span class="text-slate-400">Entrega:</span>
  <%= formatDate(o.fecha_entrega) %>
</div>


            <% if (o._tipo === 'persona') { %>
              <div><span class="text-slate-400">Evento:</span> <%= (o.evento || '-') %></div>
              <div><span class="text-slate-400">Atendido por:</span> <%= (o.atendido_por || '-') %></div>
            <% } %>

            <div class="flex items-center gap-2 mt-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px]
                <%= (o.urgencia === 'Urgente' || o.urgencia === 'Muy urgente')
                  ? 'bg-rose-500/15 text-rose-300 border border-rose-500/20'
                  : 'bg-slate-500/15 text-slate-300 border border-slate-500/20' %>">
                <%= o.urgencia || 'Normal' %>
              </span>

              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px]
                <%= o.impresos ? 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/20'
                               : 'bg-amber-500/15 text-amber-300 border border-amber-500/20' %>">
                <%= o.impresos ? 'Impreso' : 'Pendiente' %>
              </span>
            </div>
          </div>

          <!-- Acciones (orden: Editar -> Imprimir -> Marcar editado -> Marcar impreso -> Ver) -->
          <div class="mt-4 flex flex-wrap gap-2">
            <% const editUrl = (o._tipo === 'persona')
              ? `/admin/ordenes/persona/${o.id}/editar`
              : `/admin/ordenes/institucion/${o.id}/editar`; %>

            <% const verUrl = (o._tipo === 'persona')
              ? `/admin/ordenes/persona/${o.id}`
              : `/admin/ordenes/institucion/${o.id}`; %>

            <% const imprimirUrl = (o._tipo === 'persona')
              ? `/admin/ordenes/persona/${o.id}/ticket`
              : `/admin/ordenes/institucion/${o.id}/ticket`; %>

            <a href="<%= editUrl %>" class="px-4 py-2 rounded-full bg-slate-800 text-slate-100 text-sm hover:bg-slate-700">
              âœï¸ Editar
            </a>

            <a href="<%= imprimirUrl %>" target="_blank" class="px-4 py-2 rounded-full bg-indigo-600/90 text-white text-sm hover:bg-indigo-500">
              ğŸ§¾ Imprimir
            </a>

            <form method="POST" action="/admin/editor/<%= o._tipo %>/<%= o.id %>/editado">
              <input type="hidden" name="returnTo" value="<%= currentUrl %>">
              <button type="submit" class="px-4 py-2 rounded-full bg-emerald-600 text-white text-sm hover:bg-emerald-500">
                âœ… Marcar editado
              </button>
            </form>

            <form method="POST" action="/admin/editor/<%= o._tipo %>/<%= o.id %>/impreso">
              <input type="hidden" name="returnTo" value="<%= currentUrl %>">
              <button type="submit" class="px-4 py-2 rounded-full bg-rose-600 text-white text-sm hover:bg-rose-500">
                ğŸ–¨ï¸ Marcar impreso
              </button>
            </form>

            <a href="<%= verUrl %>" class="px-4 py-2 rounded-full bg-slate-950/60 border border-slate-700 text-slate-100 text-sm hover:bg-slate-800">
              ğŸ‘ï¸ Ver
            </a>
          </div>
        </div>
      <% }) %>
    </div>

    <% if (!entregasRango || entregasRango.length === 0) { %>
      <div class="text-sm text-slate-400">No hay entregas en el rango.</div>
    <% } %>
  </section>

  <!-- Urgentes -->
  <section class="space-y-3 pt-2">
    <h2 class="text-lg font-semibold text-slate-100">Urgentes / Muy urgentes (<%= (urgentes || []).length %>)</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <% (urgentes || []).forEach(o => { %>
        <div class="bg-slate-900/40 border border-slate-700 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="text-sm text-slate-200">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px]
                <%= o._tipo === 'persona'
                  ? 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/20'
                  : 'bg-sky-500/15 text-sky-300 border border-sky-500/20' %>">
                <%= o._tipo === 'persona' ? 'Persona' : 'InstituciÃ³n' %>
              </span>
              <span class="ml-2 text-slate-400 text-xs">ID <%= o.id %></span>
            </div>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] bg-rose-500/15 text-rose-300 border border-rose-500/20">
              <%= o.urgencia || 'Urgente' %>
            </span>
          </div>

          <div class="mt-3 text-sm text-slate-100 font-semibold">
            <%= o._tipo === 'persona' ? (o.nombre || '-') : (o.institucion || '-') %>
          </div>

          <div class="mt-2 text-xs text-slate-300">
            <div><span class="text-slate-400">Entrega:</span> <%= (o.fecha_entrega || '-') %></div>
          </div>
        </div>
      <% }) %>
    </div>

    <% if (!urgentes || urgentes.length === 0) { %>
      <div class="text-sm text-slate-400">No hay urgentes pendientes.</div>
    <% } %>
  </section>

</main>

<%- include('_foot') %>
