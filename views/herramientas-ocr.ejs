<%- include('_head', { title: 'Herramientas OCR' }) %> 

<main class="max-w-5xl mx-auto p-4 space-y-8">
  <h1 class="text-2xl font-semibold mb-2">Herramientas IA ‚Äî Listas y Mensajes</h1>
  <p class="text-sm text-slate-600">
    Panel de apoyo para Arte Fotogr√°fico: lectura de listas con OCR y generador de mensajes para WhatsApp.
  </p>

  <!-- ================== BLOQUE 1: SUBIR IMAGEN (OCR) ================== -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-3">
    <h2 class="font-semibold text-sm">1. Subir imagen de la lista (OCR)</h2>

    <form
      action="/admin/herramientas/ocr"
      method="POST"
      enctype="multipart/form-data"
      class="flex flex-col md:flex-row items-start gap-3"
    >
      <input
        type="file"
        name="imagen_lista"
        accept="image/*"
        class="border rounded px-3 py-2 text-sm"
        required
      />
      <button
        type="submit"
        class="px-4 py-2 rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 text-sm"
      >
        Procesar con OCR
      </button>
    </form>

    <p class="text-xs text-slate-500">
      Recomendaci√≥n: foto tomada desde arriba, buena luz, que la tabla ocupe la mayor parte de la imagen.
    </p>
  </section>

  <!-- ================== BLOQUE 2: TEXTO DETECTADO ================== -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-2">
    <h2 class="font-semibold text-sm">2. Texto detectado (crudo)</h2>
    <p class="text-xs text-slate-500">
      Este es el texto tal cual lo devolvi√≥ el OCR. En el paso siguiente vamos a limpiarlo,
      separar en l√≠neas y reordenar apellidos / nombres.
    </p>

    <textarea
      id="ocr_raw"
      class="w-full h-40 border rounded px-3 py-2 text-xs font-mono whitespace-pre"
      readonly
    ><%= typeof ocrText !== 'undefined' ? ocrText : '' %></textarea>

    <button
      type="button"
      onclick="copiarCrudoAEditable()"
      class="mt-2 px-3 py-1.5 rounded border text-xs text-slate-700 hover:bg-slate-50"
    >
      ‚ûú Copiar este texto a la zona editable
    </button>
  </section>

  <!-- ================== BLOQUE 3: LIMPIAR Y REORDENAR ================== -->
  <section class="grid md:grid-cols-2 gap-4">
    <!-- Lado izquierdo: texto editable -->
    <div class="border rounded-lg p-4 bg-white shadow-sm space-y-2">
      <h2 class="font-semibold text-sm">3A. Texto editable / limpieza</h2>
      <p class="text-xs text-slate-500">
        Aqu√≠ puedes corregir errores del OCR, borrar encabezados, etc. Luego pulsa
        <strong>‚ÄúLimpiar y reordenar‚Äù</strong>.
      </p>

      <textarea
        id="ocr_editable"
        class="w-full h-72 border rounded px-3 py-2 text-xs font-mono whitespace-pre"
        placeholder="Pega aqu√≠ el texto a limpiar o pulsa el bot√≥n para copiar desde 'Texto detectado (crudo)'..."
      ></textarea>

      <button
        type="button"
        onclick="limpiarYReordenar()"
        class="mt-2 px-3 py-1.5 rounded-lg text-xs text-white bg-blue-600 hover:bg-blue-700"
      >
        ‚öôÔ∏è Limpiar y reordenar (APELLIDOS APELLIDOS NOMBRES)
      </button>
    </div>

    <!-- Lado derecho: resultado final -->
    <div class="border rounded-lg p-4 bg-white shadow-sm space-y-2">
      <h2 class="font-semibold text-sm">3B. Resultado limpio (para Excel, Word, etc.)</h2>
      <p class="text-xs text-slate-500">
        El resultado se genera aqu√≠, una l√≠nea por alumno, en formato
        <strong>APELLIDO APELLIDO NOMBRES</strong>.
      </p>

      <textarea
        id="ocr_resultado"
        class="w-full h-72 border rounded px-3 py-2 text-xs font-mono whitespace-pre"
        placeholder="Aqu√≠ aparecer√° el resultado..."
      ></textarea>

      <div class="flex flex-wrap gap-2 mt-2">
        <button
          type="button"
          onclick="copiarResultado()"
          class="px-3 py-1.5 rounded-lg text-xs text-white bg-emerald-600 hover:bg-emerald-700"
        >
          üìã Copiar resultado al portapapeles
        </button>
        <button
          type="button"
          onclick="descargarTxtResultado()"
          class="px-3 py-1.5 rounded-lg text-xs border text-slate-700 hover:bg-slate-50"
        >
          ‚¨áÔ∏è Descargar como .txt
        </button>
      </div>
    </div>
  </section>

  <!-- ================================================================ -->
  <!-- ============ BLOQUE 4: GENERADOR DE MENSAJES WHATSAPP ========= -->
  <!-- ================================================================ -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-3">
    <h2 class="font-semibold text-sm">4. Generador de mensajes para WhatsApp</h2>
    <p class="text-xs text-slate-500">
      Completa los datos y genera mensajes listos para enviar por WhatsApp a tus clientes
      (recordatorio de entrega, abono/cobro, confirmaci√≥n de reserva, etc.).
    </p>

    <div class="grid md:grid-cols-2 gap-4">
      <!-- Lado izquierdo: formulario de par√°metros -->
      <div class="space-y-3">
        <div>
          <label class="block text-xs font-medium mb-1">Tipo de mensaje</label>
          <select id="msg_tipo" class="w-full px-3 py-2 border rounded text-sm">
            <option value="recordatorio">Recordatorio de entrega</option>
            <option value="cobro">Cobro suave / abono</option>
            <option value="reserva">Confirmaci√≥n de reserva</option>
          </select>
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Nombre del cliente</label>
          <input
            id="msg_nombre"
            type="text"
            class="w-full px-3 py-2 border rounded text-sm"
            placeholder="Ej.: Ana Mart√≠nez"
          />
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Tipo de sesi√≥n / evento</label>
          <input
            id="msg_evento"
            type="text"
            class="w-full px-3 py-2 border rounded text-sm"
            placeholder="Ej.: sesi√≥n de fotos de graduaci√≥n"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium mb-1">
              Fecha de entrega / evento
            </label>
            <input
              id="msg_fecha"
              type="text"
              class="w-full px-3 py-2 border rounded text-sm"
              placeholder="Ej.: viernes 25 a las 3:00 p.m."
            />
          </div>

          <div>
            <label class="block text-xs font-medium mb-1">
              Monto pendiente ($) <span class="text-[10px] text-slate-400">(solo para cobro)</span>
            </label>
            <input
              id="msg_monto"
              type="number"
              step="0.01"
              class="w-full px-3 py-2 border rounded text-sm"
              placeholder="Ej.: 15.00"
            />
          </div>
        </div>

        <button
          type="button"
          onclick="generarMensajeWhatsApp()"
          class="px-4 py-2 rounded-lg text-xs text-white bg-indigo-600 hover:bg-indigo-700"
        >
          ‚úâÔ∏è Generar mensaje
        </button>
      </div>

      <!-- Lado derecho: mensaje generado -->
      <div class="space-y-2">
        <label class="block text-xs font-medium mb-1">
          Mensaje generado (para copiar y pegar en WhatsApp)
        </label>
        <textarea
          id="msg_resultado"
          class="w-full h-56 border rounded px-3 py-2 text-xs whitespace-pre-line"
          placeholder="Aqu√≠ aparecer√° el mensaje listo para copiar..."
        ></textarea>

        <button
          type="button"
          onclick="copiarMensajeWhatsApp()"
          class="px-3 py-1.5 rounded-lg text-xs text-white bg-emerald-600 hover:bg-emerald-700"
        >
          üìã Copiar mensaje
        </button>
      </div>
    </div>
  </section>

    <!-- ================================================================ -->
  <!-- ============ BLOQUE 5: GUARDAR LISTA EN POSTGRESQL ============ -->
  <!-- ================================================================ -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-3">
    <h2 class="font-semibold text-sm">5. Guardar lista en PostgreSQL</h2>
    <p class="text-xs text-slate-500">
      Aqu√≠ puedes guardar una lista completa de estudiantes para un evento
      (facultad, carrera y grupo horario). Cada l√≠nea del √°rea de texto se
      guardar√° como un participante con su n√∫mero de lista (1, 2, 3‚Ä¶).
    </p>

    <form
      action="/admin/herramientas/lista-guardar"
      method="POST"
      class="space-y-3"
    >
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs font-medium mb-1">Facultad</label>
          <input
            type="text"
            name="facultad"
            class="w-full px-3 py-2 border rounded text-sm"
            placeholder="Ej.: FACULTAD DE INGENIER√çA Y CIENCIAS NATURALES"
            required
          />
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Carrera</label>
          <input
            type="text"
            name="carrera"
            class="w-full px-3 py-2 border rounded text-sm"
            placeholder="Ej.: INGENIER√çA EN SISTEMAS COMPUTACIONALES"
            required
          />
        </div>

        <div>
          <label class="block text-xs font-medium mb-1">Grupo / horario</label>
          <input
            type="text"
            name="grupo_horario"
            class="w-full px-3 py-2 border rounded text-sm"
            placeholder="Ej.: Quinto grupo de 1:30 a 2:10 p.m."
            required
          />
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between mb-1">
          <label class="block text-xs font-medium">
            Lista de nombres (una persona por l√≠nea)
          </label>
          <button
            type="button"
            onclick="copiarResultadoALista()"
            class="px-2 py-1 rounded border text-[11px] text-slate-700 hover:bg-slate-50"
          >
            ‚¨áÔ∏è Copiar desde ‚ÄúResultado limpio‚Äù
          </button>
        </div>
        <textarea
          id="lista_nombres"
          name="lista_nombres"
          class="w-full h-56 border rounded px-3 py-2 text-xs font-mono whitespace-pre"
          placeholder="Pega aqu√≠ los nombres, uno por l√≠nea, en el orden 1, 2, 3..."
          required
        ></textarea>
      </div>

      <button
        type="submit"
        class="px-4 py-2 rounded-lg text-xs text-white bg-emerald-600 hover:bg-emerald-700"
      >
        üíæ Guardar lista en PostgreSQL
      </button>
    </form>

    <p class="text-[11px] text-slate-400">
      Nota: esta acci√≥n insertar√° una fila por cada l√≠nea no vac√≠a. El n√∫mero de
      lista se asigna autom√°ticamente (1, 2, 3...) seg√∫n el orden de las l√≠neas.
    </p>
  </section>

</main>

<script>
  // =================== FUNCIONES OCR ===================

  // Copia el texto crudo (solo lectura) al √°rea editable
  function copiarCrudoAEditable() {
    const raw = document.getElementById('ocr_raw');
    const editable = document.getElementById('ocr_editable');
    if (!raw || !editable) return;

    editable.value = raw.value.trim();
    editable.focus();
  }

  // Limpia l√≠neas, elimina numeraci√≥n y tel√©fonos, y reordena apellidos / nombres
  function limpiarYReordenar() {
    const editable = document.getElementById('ocr_editable');
    const salida = document.getElementById('ocr_resultado');
    if (!editable || !salida) return;

    const texto = editable.value || '';
    const lineas = texto.split(/\r?\n/);
    const resultado = [];

    for (let linea of lineas) {
      let t = linea.trim();
      if (!t) continue;

      // 1) Quitar numeraci√≥n al inicio: "1 ", "12.", "3 - " etc.
      t = t.replace(/^\d+\s*[\.\-\)]?\s*/, '');

      // 2) Quitar tel√©fonos al final: secuencias largas de d√≠gitos y espacios
      t = t.replace(/\s+\d[\d\s-]{5,}$/, '').trim();

      if (!t) continue;

      // 3) Reordenar. Asumimos que el formato general es:
      //    NOMBRES APELLIDO1 APELLIDO2
      const partes = t.split(/\s+/);
      if (partes.length <= 2) {
        // Si no hay suficientes palabras, la dejamos tal cual
        resultado.push(t.toUpperCase());
        continue;
      }

      const apellido2 = partes.pop();
      const apellido1 = partes.pop();
      const nombres = partes.join(' ');

      // üëâ SIN coma, como me pediste
      const lineaFinal = `${apellido1} ${apellido2} ${nombres}`;
      resultado.push(lineaFinal.toUpperCase());
    }

    salida.value = resultado.join('\n');
  }

  // Copiar el resultado al portapapeles
  async function copiarResultado() {
    const salida = document.getElementById('ocr_resultado');
    if (!salida) return;

    const texto = salida.value.trim();
    if (!texto) {
      alert('No hay texto para copiar.');
      return;
    }

    try {
      await navigator.clipboard.writeText(texto);
      alert('Resultado copiado al portapapeles ‚úÖ');
    } catch (err) {
      console.error(err);
      alert('No se pudo copiar autom√°ticamente. Puedes copiarlo manualmente.');
    }
  }

  // Descargar el resultado como archivo .txt
  function descargarTxtResultado() {
    const salida = document.getElementById('ocr_resultado');
    if (!salida) return;

    const texto = salida.value.trim();
    if (!texto) {
      alert('No hay texto para descargar.');
      return;
    }

    const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'lista_alumnos_limpia.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  // =================== GENERADOR MENSAJES WHATSAPP ===================

  function generarMensajeWhatsApp() {
    const tipo   = document.getElementById('msg_tipo').value;
    const nombre = (document.getElementById('msg_nombre').value || '').trim();
    const evento = (document.getElementById('msg_evento').value || '').trim();
    const fecha  = (document.getElementById('msg_fecha').value || '').trim();
    const monto  = (document.getElementById('msg_monto').value || '').trim();
    const out    = document.getElementById('msg_resultado');

    let msg = '';

    const nombreMostrar = nombre ? ` ${nombre}` : '';
    const eventoMostrar = evento || 'la sesi√≥n de fotos';

    if (tipo === 'recordatorio') {
      msg =
        `Hola${nombreMostrar}, te saluda Arte Fotogr√°fico üëã\n\n` +
        `Solo queremos recordarte que tus fotograf√≠as de ${eventoMostrar} ` +
        (fecha ? `estar√°n listas para entrega el ${fecha}.` : 'ya est√°n listas para entrega en nuestro estudio.') +
        `\n\nüìç Calle Masferrer, Av. Moraz√°n 2a Av. Norte #1-2, Sonsonate.\n` +
        `üìû 2429-3010 / 7875-6115\n\n` +
        `¬°Gracias por confiar en nosotros! üì∏`;
    } else if (tipo === 'cobro') {
      const montoTexto = monto ? `un saldo pendiente de $${Number(monto).toFixed(2)} ` : 'un saldo pendiente ';
      msg =
        `Hola${nombreMostrar}, te saluda Arte Fotogr√°fico üëã\n\n` +
        `Te escribimos para comentarte que queda ${montoTexto} ` +
        `correspondiente a ${eventoMostrar}. ` +
        (fecha ? `Puedes pasar a cancelar y retirar tus fotograf√≠as el ${fecha}.` : 'Puedes pasar a cancelar y retirar tus fotograf√≠as cuando te sea posible en horario de atenci√≥n.') +
        `\n\nCualquier duda, estamos a la orden.\n` +
        `üìç Calle Masferrer, Av. Moraz√°n 2a Av. Norte #1-2, Sonsonate.\n` +
        `üìû 2429-3010 / 7875-6115`;
    } else if (tipo === 'reserva') {
      msg =
        `Hola${nombreMostrar}, te saluda Arte Fotogr√°fico üëã\n\n` +
        `Confirmamos tu reserva para ${eventoMostrar}` +
        (fecha ? ` el d√≠a ${fecha}.` : '.') +
        `\n\nPor favor llega unos minutos antes para preparar la sesi√≥n.\n` +
        `Cualquier cambio o consulta, escr√≠benos por este medio.\n\n` +
        `üì∏ Arte Fotogr√°fico\n` +
        `üìç Calle Masferrer, Av. Moraz√°n 2a Av. Norte #1-2, Sonsonate.\n` +
        `üìû 2429-3010 / 7875-6115`;
    }

    out.value = msg.trim();
  }

  async function copiarMensajeWhatsApp() {
    const out = document.getElementById('msg_resultado');
    if (!out) return;

    const texto = out.value.trim();
    if (!texto) {
      alert('No hay mensaje para copiar.');
      return;
    }

    try {
      await navigator.clipboard.writeText(texto);
      alert('Mensaje copiado al portapapeles ‚úÖ');
    } catch (err) {
      console.error(err);
      alert('No se pudo copiar autom√°ticamente. Puedes copiarlo manualmente.');
    }
  }

    function copiarResultadoALista() {
    const origen = document.getElementById('ocr_resultado');
    const destino = document.getElementById('lista_nombres');
    if (!origen || !destino) return;

    const texto = (origen.value || '').trim();
    if (!texto) {
      alert('No hay resultado limpio para copiar. Primero genera el texto en 3B.');
      return;
    }

    destino.value = texto;
    destino.focus();
  }

</script>

<%- include('_foot') %>
