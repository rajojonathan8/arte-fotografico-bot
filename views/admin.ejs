<%- include('_head', { title }) %>

<main class="max-w-6xl mx-auto p-4 space-y-6">

  <!-- T√≠tulo -->
  <header
    class="sticky top-0 z-40 bg-[#050816]/95 backdrop-blur border-b border-[#1f2937]">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">

      <!-- IZQUIERDA: Logo + t√≠tulo -->
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-emerald-500/15 flex items-center justify-center">
          <span class="text-xl">üì∏</span>
        </div>
        <div>
          <h1 class="text-sm md:text-base font-semibold tracking-tight text-slate-50">
            Panel de administraci√≥n ¬∑ Arte Fotogr√°fico
          </h1>
          <p class="text-[11px] md:text-xs text-slate-400">
            Resumen r√°pido de √≥rdenes, pagos, citas y accesos al panel.
          </p>
        </div>
      </div>

      <!-- DERECHA: Acciones -->
      <div class="flex items-center gap-2 md:gap-3">

        <!-- Bot√≥n: Ir al panel del editor -->
        <a
          href="/admin/editor"
          class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full
                 text-[11px] md:text-xs bg-sky-500/90 text-white
                 hover:bg-sky-400 transition-colors">
          <span class="text-xs">üñ•Ô∏è</span>
          <span>Panel del editor</span>
        </a>

        <!-- Bot√≥n: Cerrar sesi√≥n -->
        <form method="POST" action="/admin/login" class="inline">
          <button
            type="submit"
            class="px-3 py-1.5 text-xs rounded-full bg-rose-500 text-white hover:bg-rose-600"
          >
            Cerrar sesi√≥n
          </button>
        </form>

      </div>
    </div>
  </header>

  <!-- ================= PANELES R√ÅPIDOS (arriba) ================= -->
  <section class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <% (cards || []).forEach(function(card) { %>
      <a
        href="<%= card.href %>"
        class="flex items-start gap-3 bg-slate-900/60 border border-slate-700 rounded-2xl px-4 py-3 hover:border-emerald-500/70 hover:bg-slate-900 transition"
      >
        <div class="w-9 h-9 rounded-2xl bg-emerald-500/15 flex items-center justify-center text-xl">
          <%= card.icon %>
        </div>
        <div class="flex-1">
          <h2 class="text-sm font-semibold text-slate-100"><%= card.title %></h2>
          <p class="text-xs text-slate-400"><%= card.desc %></p>
        </div>
      </a>
    <% }) %>
  </section>

  <!-- ================= TARJETAS DE TOTALES ================= -->
  <section class="grid md:grid-cols-4 gap-4">

    <!-- √ìrdenes totales -->
    <article class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
      <p class="text-xs font-semibold text-slate-400 uppercase">√ìrdenes totales</p>
      <p class="mt-2 text-3xl font-bold text-slate-50"><%= totalOrdenes || 0 %></p>
      <p class="mt-1 text-xs text-slate-400">
        Personas: <%= totalPersonas || 0 %> ¬∑ Instituciones: <%= totalInstituciones || 0 %>
      </p>
    </article>

    <!-- Total facturado personas -->
    <article class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
      <p class="text-xs font-semibold text-slate-400 uppercase">Total facturado (persons)</p>
      <p class="mt-2 text-2xl font-bold text-emerald-400">
        $<%= (resumenPersonas.totalPrecio || 0).toFixed(2) %>
      </p>
      <p class="mt-1 text-xs text-slate-400">
        Abonado: $<%= (resumenPersonas.totalAbono || 0).toFixed(2) %> ¬∑
        Saldo: $<%= (resumenPersonas.totalSaldo || 0).toFixed(2) %>
      </p>
    </article>

    <!-- Total facturado instituciones -->
    <article class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
      <p class="text-xs font-semibold text-slate-400 uppercase">Total facturado (instituciones)</p>
      <p class="mt-2 text-2xl font-bold text-emerald-400">
        $<%= (resumenInstituciones.totalPrecio || 0).toFixed(2) %>
      </p>
      <p class="mt-1 text-xs text-slate-400">
        Abonado: $<%= (resumenInstituciones.totalAbono || 0).toFixed(2) %> ¬∑
        Saldo: $<%= (resumenInstituciones.totalSaldo || 0).toFixed(2) %>
      </p>
    </article>

    <!-- Citas -->
    <article class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
      <p class="text-xs font-semibold text-slate-400 uppercase">Citas</p>
      <p class="mt-2 text-2xl font-bold text-sky-400">
        <%= (resumenCitas && resumenCitas.total) || 0 %>
      </p>
      <p class="mt-1 text-xs text-slate-400">
        Hoy: <%= (resumenCitas && resumenCitas.hoy) || 0 %> ¬∑
        Pendientes: <%= (resumenCitas && resumenCitas.pendientes) || 0 %>
      </p>
    </article>
  </section>

  <% if (resumenEvento && resumenEvento.total_participantes > 0) { %>
  <section class="mt-6">
    <h2 class="text-sm font-semibold text-slate-200 mb-2">
      Resumen del evento ‚Äî participantes y tel√©fonos
    </h2>

    <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-6">
      <div class="rounded-xl bg-[#151921] border border-[#2b2f34] p-3">
        <p class="text-[11px] text-slate-400 uppercase tracking-wide">Participantes</p>
        <p class="text-xl font-semibold text-slate-50"><%= resumenEvento.total_participantes %></p>
      </div>

      <div class="rounded-xl bg-[#151921] border border-emerald-700/60 p-3">
        <p class="text-[11px] text-emerald-300 uppercase tracking-wide">Con tel√©fono</p>
        <p class="text-xl font-semibold text-emerald-400"><%= resumenEvento.con_telefono %></p>
      </div>

      <div class="rounded-xl bg-[#151921] border border-amber-600/70 p-3">
        <p class="text-[11px] text-amber-300 uppercase tracking-wide">Sin tel√©fono</p>
        <p class="text-xl font-semibold text-amber-400"><%= resumenEvento.sin_telefono %></p>
      </div>

      <div class="rounded-xl bg-[#151921] border border-[#2b2f34] p-3">
        <p class="text-[11px] text-slate-400 uppercase tracking-wide">Facultades</p>
        <p class="text-xl font-semibold text-slate-50"><%= resumenEvento.facultades %></p>
      </div>

      <div class="rounded-xl bg-[#151921] border border-[#2b2f34] p-3">
        <p class="text-[11px] text-slate-400 uppercase tracking-wide">Carreras</p>
        <p class="text-xl font-semibold text-slate-50"><%= resumenEvento.carreras %></p>
      </div>

      <div class="rounded-xl bg-[#151921] border border-[#2b2f34] p-3">
        <p class="text-[11px] text-slate-400 uppercase tracking-wide">Grupos / horarios</p>
        <p class="text-xl font-semibold text-slate-50"><%= resumenEvento.grupos %></p>
      </div>
    </div>
  </section>
  <% } %>

  <!-- ================= RESUMEN DE PAGOS + ENTREGAS ================= -->
  <section class="grid md:grid-cols-2 gap-4">

    <!-- Resumen de pagos global -->
    <article class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4 space-y-3">
      <h2 class="text-sm font-semibold text-slate-100">
        Resumen de pagos (personas + instituciones)
      </h2>

      <div class="space-y-2 text-sm">
        <div class="flex items-center justify-between">
          <span class="text-slate-400">Facturado total</span>
          <span class="font-semibold text-slate-50">
            $<%= (resumenGlobal.facturadoTotal || 0).toFixed(2) %>
          </span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-400">Total abonado</span>
          <span class="font-semibold text-emerald-400">
            $<%= (resumenGlobal.abonadoTotal || 0).toFixed(2) %>
          </span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-400">Saldo pendiente</span>
          <span class="font-semibold text-amber-400">
            $<%= (resumenGlobal.saldoTotal || 0).toFixed(2) %>
          </span>
        </div>
      </div>

      <p class="mt-2 text-xs text-slate-500">
        Para ver el detalle, entra al m√≥dulo de √ìrdenes y libros.
      </p>

      <!-- ‚úÖ NUEVO: Editadas / Impresas (si resumenEditor viene del backend) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="rounded-2xl border border-white/10 bg-slate-900/40 p-4">
          <div class="text-xs text-slate-300">Editadas</div>
          <div class="mt-1 text-2xl font-semibold text-slate-100">
            <%= (resumenEditor?.editadas ?? 0) %>
          </div>
          <div class="mt-1 text-[11px] text-slate-400">
            Personas: <%= (resumenEditor?.editadasPersonas ?? 0) %> ¬∑ Instituciones: <%= (resumenEditor?.editadasInst ?? 0) %>
          </div>
        </div>

        <div class="rounded-2xl border border-white/10 bg-slate-900/40 p-4">
          <div class="text-xs text-slate-300">Impresas</div>
          <div class="mt-1 text-2xl font-semibold text-slate-100">
            <%= (resumenEditor?.impresas ?? 0) %>
          </div>
          <div class="mt-1 text-[11px] text-slate-400">
            Personas: <%= (resumenEditor?.impresasPersonas ?? 0) %> ¬∑ Instituciones: <%= (resumenEditor?.impresasInst ?? 0) %>
          </div>
        </div>
      </div>

    </article>

    <!-- Pr√≥ximas entregas (notificaciones) -->
    <article class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4">
      <%
        function fechaCorta(value) {
          if (!value) return '';
          const d = (value instanceof Date) ? value : new Date(value);
          if (isNaN(d.getTime())) return '';
          return d.toISOString().slice(0, 10);
        }

        function isoDT(value) {
          if (!value) return '';
          const d = (value instanceof Date) ? value : new Date(value);
          if (isNaN(d.getTime())) return '';
          // YYYY-MM-DD HH:mm (simple)
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          const hh = String(d.getHours()).padStart(2,'0');
          const mi = String(d.getMinutes()).padStart(2,'0');
          return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
        }
      %>

      <h2 class="text-sm font-semibold text-slate-100 flex items-center justify-between">
        Pr√≥ximas entregas (3 d√≠as)
        <span class="text-xs font-normal text-slate-400">
          <%= (proximasEntregas && proximasEntregas.length) || 0 %> pendientes
        </span>
      </h2>

      <% if (!proximasEntregas || proximasEntregas.length === 0) { %>
        <p class="mt-3 text-xs text-slate-500">
          No hay entregas programadas en los pr√≥ximos 3 d√≠as.
        </p>
      <% } else { %>
        <ul class="mt-3 space-y-2 text-sm">
          <% proximasEntregas.forEach(function(o) {
               const tipo = o._tipo === 'institucion' ? 'Instituci√≥n' : 'Persona';
               const nombre = o.nombre || o.institucion || 'Sin nombre';
               const saldoItem = Math.max((Number(o.precio || 0) - Number(o.abono || 0)) || 0, 0);
               const urg = o.urgencia || 'Normal';

               let rowClass = 'border-slate-800 bg-slate-950/40';
               if (urg === 'Urgente') rowClass = 'border-amber-600/70 bg-amber-900/30';
               else if (urg === 'Muy urgente') rowClass = 'border-red-600/70 bg-red-900/40';

               let urgClass = 'bg-slate-800 text-slate-100';
               if (urg === 'Urgente') urgClass = 'bg-amber-500/90 text-slate-900';
               else if (urg === 'Muy urgente') urgClass = 'bg-red-500/90 text-white';

               // ‚úÖ badges editor (requiere que el query traiga editado/impresos y editado_at/impreso_at)
               const isEditado = !!o.editado;
               const isImpreso = !!o.impresos; // (tu columna se llama impresos)
          %>
            <li
              class="rounded-xl border px-3 py-2 cursor-pointer <%= rowClass %>"
              onclick="window.location.href='<%= o._tipo === 'institucion'
                ? '/admin/ordenes/institucion/' + o.id
                : '/admin/ordenes/persona/' + o.id %>'"
            >
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="flex gap-2 items-center flex-wrap">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold
                                 <%= tipo === 'Instituci√≥n' ? 'bg-sky-900/60 text-sky-300' : 'bg-emerald-900/60 text-emerald-300' %>">
                      <%= tipo %>
                    </span>

                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold <%= urgClass %>">
                      <%= urg %>
                    </span>

                    <% if (isEditado) { %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-500/15 text-emerald-300 border border-emerald-500/25">
                        Editado
                      </span>
                    <% } %>

                    <% if (isImpreso) { %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-fuchsia-500/15 text-fuchsia-300 border border-fuchsia-500/25">
                        Impreso
                      </span>
                    <% } %>
                  </div>

                  <p class="mt-1 text-sm text-slate-100 truncate max-w-[260px]">
                    <%= nombre %>
                  </p>

                  <% if (isEditado && o.editado_at) { %>
                    <p class="mt-1 text-[11px] text-slate-400">
                      Editado: <span class="text-slate-200"><%= isoDT(o.editado_at) %></span>
                    </p>
                  <% } %>
                  <% if (isImpreso && o.impreso_at) { %>
                    <p class="text-[11px] text-slate-400">
                      Impreso: <span class="text-slate-200"><%= isoDT(o.impreso_at) %></span>
                    </p>
                  <% } %>
                </div>

                <div class="text-right shrink-0">
                  <p class="text-xs text-slate-200">
                    Entrega: <span class="font-semibold"><%= fechaCorta(o._fecha || o.fecha_entrega) %></span>
                  </p>
                  <p class="text-xs text-slate-400">
                    Saldo: $<%= saldoItem.toFixed(2) %>
                  </p>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </article>

  </section>

  <!-- ================= ENTREGAS ATRASADAS ================= -->
  <!-- <section class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4 space-y-3">
    <h2 class="text-sm font-semibold text-slate-100 flex items-center justify-between">
      Entregas atrasadas
      <span class="text-xs font-normal text-slate-400">
        <%= (entregasAtrasadas && entregasAtrasadas.length) || 0 %> pendientes
      </span>
    </h2>

    <% if (!entregasAtrasadas || entregasAtrasadas.length === 0) { %>
      <p class="text-xs text-slate-500">
        No hay entregas atrasadas registradas.
      </p>
    <% } else { %>
      <ul class="space-y-2 text-sm">
        <% entregasAtrasadas.forEach(function(o) {
             const tipo = o._tipo === 'institucion' ? 'Instituci√≥n' : 'Persona';
             const nombre = o.nombre || o.institucion || 'Sin nombre';
             const saldoItem = Math.max((Number(o.precio || 0) - Number(o.abono || 0)) || 0, 0);
             const urg = o.urgencia || 'Normal';
        %>
          <li
            class="flex items-start justify-between rounded-xl border border-red-600/70 bg-red-900/40 px-3 py-2 cursor-pointer"
            onclick="window.location.href='<%= o._tipo === 'institucion'
              ? '/admin/ordenes/institucion/' + o.id
              : '/admin/ordenes/persona/' + o.id %>'"
          >
            <div>
              <div class="flex gap-2 items-center">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold
                               <%= tipo === 'Instituci√≥n' ? 'bg-sky-900/60 text-sky-300' : 'bg-emerald-900/60 text-emerald-300' %>">
                  <%= tipo %>
                </span>

                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-red-500 text-white">
                  Atrasada ¬∑ <%= urg %>
                </span>
              </div>
              <p class="mt-1 text-sm text-slate-100 truncate max-w-[220px]">
                <%= nombre %>
              </p>
            </div>
            <div class="text-right">
              <p class="text-xs text-slate-200">
                Entrega: <span class="font-semibold">
                  <%= fechaCorta(o._fecha || o.fecha_entrega) %>
                </span>
              </p>
              <p class="text-xs text-slate-400">
                Saldo: $<%= saldoItem.toFixed(2) %>
              </p>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </section> -->

</main>

<%- include('_foot') %>
