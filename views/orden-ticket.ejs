<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title><%= title || 'Ticket' %></title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f3f4f6;
    }

    .no-print {
      padding: 6px 10px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .no-print button {
      background: #22c55e;
      border: none;
      color: #fff;
      border-radius: 999px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .no-print a {
      color: #9ca3af;
      text-decoration: none;
      font-size: 12px;
      margin-left: 8px;
    }

    .recibo-logo {
      text-align: center;
    }
    .recibo-logo img {
      max-width: 170px;
      height: auto;
    }
    .img-qr img {
      max-width: 200px;
      height: auto;
    }

    /* CONTENEDOR TICKET 80 mm */
    .ticket-wrapper {
      width: 80mm;
      margin: 8px auto;
      background: #ffffff;
      padding: 4mm 3mm;
      border: 1px solid #e5e7eb;
    }

    .ticket {
      font-size: 25px;
      line-height: 1.25;
      color: #111827;
    }

    .center { text-align: center; }
    .right  { text-align: right; }

    .title {
      font-weight: 900;
      font-size: 30px;
      margin-bottom: 2px;
    }

    .subtitle {
      font-size: 25px;
      text-transform: uppercase;
    }

    .small {
      font-size: 16px;
      font-weight: 790;
    }

    hr {
      border: 0;
      border-top: 1px dashed #9ca3af;
      margin: 4px 0;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .label {
      font-weight: 900;
      font-size: 24px;
      margin-right: 4px;
    }

    .urgencia1 {
      font-weight: 750;
      font-size: 18px;
    }

    .separator {
      border-top: 1px dashed #9ca3af;
      margin: 4px 0;
    }

    .mt-2 { margin-top: 4px; }
    .mt-4 { margin-top: 8px; }

    .observaciones {
      min-height: 20mm;
      border: 1px solid #d1d5db;
      margin-top: 4px;
      padding: 2px;
      font-size: 23px;
      white-space: pre-line;
    }

    .vertical-note {
      font-size: 22px;
      margin-top: 4px;
    }

    @page {
      /* ANCHO 80 mm, alto autom√°tico (la impresora corta) */
      size: 80mm auto;
      margin: 3mm;
    }

    @media print {
      body { background: #fff; }
      .no-print { display: none; }
      .ticket-wrapper {
        margin: 0;
        border: none;
      }
    }
  </style>
</head>
<body>
  <div class="no-print">
    <div>
      Ticket ‚Äî <%= tipo === 'institucion' ? 'Instituci√≥n' : 'Persona' %>
    </div>
    <div>
      <button onclick="window.print()">üñ® Imprimir ticket</button>
      <a href="/admin/ordenes?tab=<%= tipo === 'institucion' ? 'instituciones' : 'personas' %>">
        ‚Üê Volver
      </a>
    </div>
  </div>

  <%
    function formatFecha(value) {
      if (!value) return '';
      const d = (value instanceof Date) ? value : new Date(value);
      if (isNaN(d.getTime())) return '';
      return d.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    const precioLocal = Number(precio ?? orden.precio ?? 0) || 0;
    const abonoLocal  = Number(abono  ?? orden.abono  ?? 0) || 0;
    const saldoLocal  = Math.max(precioLocal - abonoLocal, 0);
    const fechaToma   = formatFecha(orden.fecha_toma);
    const fechaEnt    = formatFecha(orden.fecha_entrega);
  %>

  <div class="ticket-wrapper">
    <div class="ticket">

      <!-- CABECERA -->
      <div class="center">
        <div class="recibo-logo">
          <img src="/admin-public/LOGO SIN FONDO (2).png" alt="Arte Fotogr√°fico">
        </div>

        <div class="small">
          Calle Masferrer, Av. Moraz√°n 2a Av. Norte #1-2<br />
          Sonsonate, El Salvador<br />
          Tel: 2429-1030/7815-6115/6178-2099
        </div>
      </div>

      <hr />

      <div class="row small">
        <span class="label">Ticket:</span>
        <span>
          <% if (tipo === 'persona') { %>
            <%= orden.numero_orden || (1000 + idx) %>
          <% } else { %>
            <%= orden.id || (2000 + idx) %>
          <% } %>
        </span>
      </div>

      <div class="row small">
        <span class="label">Fecha toma:</span>
        <span><%= fechaToma || '--' %></span>
      </div>

      <% if (fechaEnt) { %>
      <div class="row small">
        <span class="label">Fecha Entrega:</span>
        <span><%= fechaEnt %></span>
      </div>
      <% } %>

      <div class="row small">
        <span class="label">Tipo de Entrega:</span>
        <span class="urgencia1"><%= orden.urgencia || 'Normal' %></span>
      </div>

      <hr />

      <!-- CLIENTE / INSTITUCI√ìN -->
      <div class="small">
        <div class="label">Orden de:</div>
        <div>
          <% if (tipo === 'persona') { %>
            <%= orden.nombre || '' %>
          <% } else { %>
            <%= orden.institucion || '' %>
            <% if (orden.nombre) { %><br />Contacto: <%= orden.nombre %><% } %>
          <% } %>
        </div>

        <% if (orden.telefono) { %>
          <div class="mt-2">
            <span class="label">Tel:</span> <%= orden.telefono %>
          </div>
        <% } %>

        <% if (orden.evento) { %>
          <div class="mt-2">
            <span class="label">Evento:</span> <%= orden.evento %>
          </div>
        <% } %>

        <% if (orden.atendido_por) { %>
          <div class="mt-2">
            <span class="label">Atendido por:</span> <%= orden.atendido_por %>
          </div>
        <% } %>
      </div>

      <hr />

      <!-- DETALLE B√ÅSICO (persona / instituci√≥n) -->
      <div class="small">
        <% if (tipo === 'institucion') { %>
          <% if (orden.seccion) { %>
            <div class="row">
              <span class="label">Secci√≥n:</span>
              <span><%= orden.seccion %></span>
            </div>
          <% } %>

          <% if (orden.paquete) { %>
            <div class="row">
              <span class="label">Paquete:</span>
              <span><%= orden.paquete %></span>
            </div>
          <% } %>

          <div class="row">
            <span class="label">Tomas:</span>
            <span>
              Princ: <%= orden.toma_principal || 0 %>,
              C1: <%= orden.collage1 || 0 %>,
              C2: <%= orden.collage2 || 0 %>,
              C3: <%= orden.collage3 || 0 %>
            </span>
          </div>
        <% } else { %>
          <div class="row">
            <span class="label">N¬∞ orden:</span>
            <span><%= orden.numero_orden || '' %></span>
          </div>
          <div class="row">
            <span class="label">N¬∞ toma:</span>
            <span><%= orden.numero_toma || '' %></span>
          </div>
        <% } %>
      </div>

      <hr />

      <!--  NUEVO: DETALLE TIPO FACTURA (solo personas y si hay datos) -->
      <% if (tipo === 'persona' && typeof detalles !== 'undefined' && detalles && detalles.length) { %>
        <div class="small">
          <div class="label">Detalle:</div>

          <table style="width:100%; font-size:16px; margin-top:2px; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left;">Cant</th>
                <th style="text-align:left;">Descripci√≥n</th>
                <th style="text-align:right;">P. unit</th>
                <th style="text-align:right;">Sub</th>
              </tr>
            </thead>
            <tbody>
              <% let totalDetalle = 0; %>
              <% detalles.forEach(function(it) {
                   const cant = Number(it.cantidad || 0);
                   const pu   = Number(it.precio_unitario || 0);
                   const sub  = Number(it.subtotal || (cant * pu));
                   totalDetalle += sub;
              %>
                <tr>
                  <td><%= cant %></td>
                  <td><%= it.descripcion || '' %></td>
                  <td class="right">$ <%= pu.toFixed(2) %></td>
                  <td class="right">$ <%= sub.toFixed(2) %></td>
                </tr>
              <% }) %>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" style="text-align:right; font-weight:700; padding-top:2px;">
                  Total detalle:
                </td>
                <td class="right" style="font-weight:700;">
                  $ <%= totalDetalle.toFixed(2) %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <hr />
      <% } %>

      <!-- PAGO -->
      <div class="small">
        <div class="row">
          <span class="label">Precio:</span>
          <span>$ <%= precioLocal.toFixed(2) %></span>
        </div>
        <div class="row">
          <span class="label">Abono:</span>
          <span>$ <%= abonoLocal.toFixed(2) %></span>
        </div>
        <div class="row">
          <span class="label">Saldo:</span>
          <span>$ <%= saldoLocal.toFixed(2) %></span>
        </div>
        <div class="row">
          <span class="label">Pago:</span>
          <span><%= pagoEstado || '' %></span>
        </div>
      </div>

      <div class="small mt-2">
        * Todo abono o reservaci√≥n de evento no es reembolsable.
      </div>

      <div class="vertical-note">
        NOTA: FOTOS DISPONIBLES POR UN PERIODO DE 30 D√çAS.
      </div>

      <hr />

      <!-- OBSERVACIONES -->
      <div class="small">
        Observaciones:
        <div class="observaciones">
          <!-- (Por ahora se deja vac√≠o para escribir a mano) -->
        </div>
      </div>

      <div class="center small mt-2">
        ¬°Gracias por su preferencia! Escanee el c√≥digo para chatear.<br />
      </div>

      <div class="center">
        <div class="img-qr">
          <img src="/admin-public/qr-code.png" alt="Arte Fotogr√°fico">
        </div>
      </div>

    </div>

    <div class="separator"></div>
  </div>
</body>
</html>
