<%- include('_head', { title }) %>

<main class="max-w-5xl mx-auto p-4 space-y-6">
  <h1 class="text-2xl font-semibold mb-2">Panel de citas</h1>
  <p class="text-sm text-slate-600">
    Aquí puedes ver, filtrar y actualizar el estado de las citas del estudio.
    Más adelante podemos conectar esto con Google Calendar para que se llenen automáticamente.
  </p>

  <!-- ================== FILTROS ================== -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-3">
    <h2 class="text-sm font-semibold">Filtros</h2>

    <form method="GET" action="/admin/citas" class="grid md:grid-cols-4 gap-3 items-end">
      <div>
        <label class="block text-xs font-medium mb-1">Desde</label>
        <input
          type="datetime-local"
          name="fecha_desde"
          value="<%= fechaDesde || '' %>"
          class="w-full px-3 py-2 border rounded text-sm"
        />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">Hasta</label>
        <input
          type="datetime-local"
          name="fecha_hasta"
          value="<%= fechaHasta || '' %>"
          class="w-full px-3 py-2 border rounded text-sm"
        />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">Buscar (cliente / sesión / tel)</label>
        <input
          type="text"
          name="q"
          value="<%= busqueda || '' %>"
          class="w-full px-3 py-2 border rounded text-sm"
          placeholder="Ej.: Ana, graduación..."
        />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">Estado</label>
        <select
          name="estado"
          class="w-full px-3 py-2 border rounded text-sm"
        >
          <option value="" <%= !estadoFil ? 'selected' : '' %>>Todos</option>
          <option value="pendiente" <%= estadoFil === 'pendiente' ? 'selected' : '' %>>Pendiente</option>
          <option value="atendida" <%= estadoFil === 'atendida' ? 'selected' : '' %>>Atendida</option>
          <option value="cancelada" <%= estadoFil === 'cancelada' ? 'selected' : '' %>>Cancelada</option>
        </select>
      </div>

      <div class="md:col-span-4 flex justify-end gap-2">
        <a
          href="/admin/citas"
          class="px-3 py-1.5 rounded border text-xs text-slate-700 hover:bg-slate-50"
        >
          Limpiar filtros
        </a>
        <button
          type="submit"
          class="px-4 py-2 rounded-lg text-xs text-white bg-emerald-600 hover:bg-emerald-700"
        >
          Aplicar filtros
        </button>
      </div>
    </form>
  </section>

  <!-- ================== NUEVA CITA ================== -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-3">
    <h2 class="text-sm font-semibold">Nueva cita</h2>
    <p class="text-xs text-slate-500">
      Registra una cita rápida. Luego, si quieres, puedes vincularla mentalmente con un evento de Google Calendar.
    </p>

    <form method="POST" action="/admin/citas/nueva" class="grid md:grid-cols-4 gap-3">
      <div class="md:col-span-2">
        <label class="block text-xs font-medium mb-1">Cliente</label>
        <input
          type="text"
          name="cliente"
          class="w-full px-3 py-2 border rounded text-sm"
          placeholder="Nombre del cliente"
          required
        />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">Teléfono</label>
        <input
          type="text"
          name="telefono"
          class="w-full px-3 py-2 border rounded text-sm"
          placeholder="5037XXXXXX"
        />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">Sesión / servicio</label>
        <input
          type="text"
          name="sesion"
          class="w-full px-3 py-2 border rounded text-sm"
          placeholder="Ej.: fotos de graduación"
        />
      </div>

      <div>
        <label class="block text-xs font-medium mb-1">Fecha y hora</label>
        <input
          type="datetime-local"
          name="fecha"
          class="w-full px-3 py-2 border rounded text-sm"
          required
        />
      </div>

      <div class="md:col-span-3">
        <label class="block text-xs font-medium mb-1">Notas (opcional)</label>
        <input
          type="text"
          name="notas"
          class="w-full px-3 py-2 border rounded text-sm"
          placeholder="Ej.: traer ropa de cambio, pago pendiente, etc."
        />
      </div>

      <div class="md:col-span-4 flex justify-end">
        <button
          type="submit"
          class="px-4 py-2 rounded-lg text-xs text-white bg-blue-600 hover:bg-blue-700"
        >
          Guardar cita
        </button>
      </div>
    </form>
  </section>

  <!-- ================== LISTADO DE CITAS ================== -->
  <section class="border rounded-lg p-4 bg-white shadow-sm space-y-3">
    <div class="flex justify-between items-center">
      <h2 class="text-sm font-semibold">Listado de citas</h2>
      <span class="text-xs text-slate-500">
        Total: <strong><%= citas.length %></strong>
      </span>
    </div>

    <% if (!citas || citas.length === 0) { %>
      <p class="text-xs text-slate-500">No hay citas registradas con los filtros actuales.</p>
    <% } else { %>
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs border border-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-2 py-1 border-b text-left">Fecha / hora</th>
              <th class="px-2 py-1 border-b text-left">Cliente</th>
              <th class="px-2 py-1 border-b text-left">Sesión</th>
              <th class="px-2 py-1 border-b text-left">Teléfono</th>
              <th class="px-2 py-1 border-b text-left">Estado</th>
              <th class="px-2 py-1 border-b text-left">Notas</th>
              <th class="px-2 py-1 border-b text-left">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% citas.forEach((cita) => { %>
              <tr class="hover:bg-slate-50">
                <td class="px-2 py-1 border-b align-top">
                  <%= cita.fecha || '' %>
                </td>
                <td class="px-2 py-1 border-b align-top">
                  <%= cita.cliente || '' %>
                </td>
                <td class="px-2 py-1 border-b align-top">
                  <%= cita.sesion || '' %>
                </td>
                <td class="px-2 py-1 border-b align-top">
                  <%= cita.telefono || '' %>
                </td>
                <td class="px-2 py-1 border-b align-top">
                  <% const est = (cita.estado || 'Pendiente'); %>
                  <span class="
                    inline-flex px-2 py-0.5 rounded-full text-[10px] font-semibold
                    <%= est === 'Pendiente' ? 'bg-yellow-100 text-yellow-700' : '' %>
                    <%= est === 'Atendida'  ? 'bg-emerald-100 text-emerald-700' : '' %>
                    <%= est === 'Cancelada' ? 'bg-rose-100 text-rose-700' : '' %>
                  ">
                    <%= est %>
                  </span>
                </td>
                <td class="px-2 py-1 border-b align-top">
                  <%= cita.notas || '' %>
                </td>
                <td class="px-2 py-1 border-b align-top space-y-1">
                  <form
                    method="POST"
                    action="/admin/citas/<%= cita.id %>/estado"
                    class="flex items-center gap-1"
                  >
                    <select
                      name="estado"
                      class="px-1 py-0.5 border rounded text-[11px]"
                    >
                      <option value="Pendiente" <%= est === 'Pendiente' ? 'selected' : '' %>>
                        Pendiente
                      </option>
                      <option value="Atendida" <%= est === 'Atendida' ? 'selected' : '' %>>
                        Atendida
                      </option>
                      <option value="Cancelada" <%= est === 'Cancelada' ? 'selected' : '' %>>
                        Cancelada
                      </option>
                    </select>
                    <button
                      type="submit"
                      class="px-2 py-0.5 rounded text-[11px] text-white bg-slate-700 hover:bg-slate-800"
                    >
                      Guardar
                    </button>
                  </form>

                  <form
                    method="POST"
                    action="/admin/citas/<%= cita.id %>/eliminar"
                    onsubmit="return confirm('¿Seguro que deseas eliminar esta cita?');"
                  >
                    <button
                      type="submit"
                      class="px-2 py-0.5 rounded text-[11px] text-white bg-rose-600 hover:bg-rose-700"
                    >
                      Eliminar
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>
</main>

<%- include('_foot') %>
